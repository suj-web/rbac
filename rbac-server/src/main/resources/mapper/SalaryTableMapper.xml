<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.rbac.mapper.SalaryTableMapper">

    <!-- 通用查询映射结果 -->
    <resultMap id="BaseResultMap" type="com.example.rbac.pojo.SalaryTable">
        <id column="id" property="id" />
        <result column="employee_id" property="employeeId" />
        <result column="salary_id" property="salaryId" />
        <result column="date" property="date" />
        <result column="bonus" property="bonus" />
        <result column="all_salary" property="allSalary" />
        <result column="attendance_deduction" property="attendanceDeduction" />
        <result column="leave_deduction" property="leaveDeduction" />
        <result column="enabled" property="enabled" />
        <result column="status" property="status" />
        <result column="is_delete" property="isDelete" />
        <result column="gmt_created" property="gmtCreated" />
        <result column="gmt_modified" property="gmtModified" />
    </resultMap>

    <resultMap id="SalaryTableResultMap" type="com.example.rbac.pojo.SalaryTable" extends="BaseResultMap">
        <association property="employee" javaType="com.example.rbac.pojo.Employee">
            <id column="empId" property="id" />
            <result column="empName" property="name" />
            <result column="workId" property="workId" />
            <association property="department" javaType="com.example.rbac.pojo.Department">
                <result column="depName" property="name"/>
            </association>
            <association property="position" javaType="com.example.rbac.pojo.Position">
                <result column="posName" property="name" />
            </association>
        </association>
        <association property="salary" javaType="com.example.rbac.pojo.Salary"
                     column="salaryId" select="com.example.rbac.mapper.SalaryMapper.selectById">
        </association>
    </resultMap>

    <!-- 通用查询结果列 -->
    <sql id="Base_Column_List">
        id, employee_id, salary_id, date, attendance_deduction, leave_deduction, bonus, all_salary, enabled, status, is_delete, gmt_created, gmt_modified
    </sql>

    <!--    获取所有员工当月工资信息-->
    <select id="getAllSalaryTableByCurrentMonth" resultMap="SalaryTableResultMap">
        SELECT
            emp.id AS empId,
            emp.`name` AS empName,
            emp.work_id AS workId,
            emp.salary_id AS salaryId,
            dep.`name` AS depName,
            pos.`name` AS posName,
            st.*
        FROM
            t_employee emp,
            t_department dep,
            t_salary_table st,
            t_position pos
        WHERE
            emp.department_id = dep.id
        AND emp.work_state = '在职'
        AND emp.is_delete = FALSE
        AND emp.id = st.employee_id
        AND emp.position_id = pos.id
        <if test="null != depId">
            AND dep.id = #{depId}
        </if>
        <if test="null!=localDate and ''!=localDate">
            AND date_format(st.date,'%Y-%m-%d') LIKE CONCAT('%',#{localDate},'%')
        </if>
        ORDER BY st.id
    </select>

<!--    获取所有工资单-->
    <select id="getAllSalaryTables" resultMap="SalaryTableResultMap">
        SELECT
            st.*,
            emp.id AS empId,
            emp.`name` AS empName,
            emp.work_id AS workId,
            st.salary_id AS salaryId,
            dep.`name` AS depName,
            pos.`name` AS posName
        FROM
            t_employee emp,
            t_department dep,
            t_salary_table st,
            t_position pos
        WHERE
            emp.department_id = dep.id
        AND emp.work_state = '在职'
        AND emp.is_delete = FALSE
        AND emp.id = st.employee_id
        AND emp.position_id = pos.id
        <if test="null != depId">
            AND dep.id = #{depId}
        </if>
        <if test="null!=localDate and ''!=localDate">
            AND date_format(st.date,'%Y-%m-%d') LIKE CONCAT('%',#{localDate},'%')
        </if>
        ORDER BY st.id
    </select>

<!--    获取当月工资账单用于导出excel-->
    <select id="getAllSalaryTablesForExcel" resultMap="SalaryTableResultMap">
        SELECT
            st.*,
            emp.id AS empId,
            emp.`name` AS empName,
            emp.work_id AS workId,
            st.salary_id AS salaryId,
            dep.`name` AS depName,
            pos.`name` AS posName
        FROM
            t_employee emp,
            t_department dep,
            t_salary_table st,
            t_position pos
        WHERE
            emp.department_id = dep.id
        AND emp.work_state = '在职'
        AND emp.is_delete = FALSE
        AND emp.id = st.employee_id
        AND emp.position_id = pos.id
        <if test="null!=localDate and ''!=localDate">
            AND date_format(st.date,'%Y-%m-%d') LIKE CONCAT('%',#{localDate},'%')
        </if>
        ORDER BY st.id
    </select>
</mapper>
